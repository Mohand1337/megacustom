name: Build Windows Portable

on:
  push:
    branches: [ main, master ]
    paths:
      - 'qt-gui/**'
      - 'src/**'
      - '.github/workflows/build-windows.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

env:
  QT_VERSION: '6.6.0'
  BUILD_TYPE: Release

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Clone MEGA SDK
      run: |
        mkdir -p third_party
        git clone --depth 1 https://github.com/meganz/sdk.git third_party/sdk
      shell: bash

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: windows
        target: desktop
        arch: win64_msvc2019_64
        modules: qtnetworkauth
        cache: true

    - name: Setup vcpkg
      run: |
        git clone https://github.com/microsoft/vcpkg.git
        ./vcpkg/bootstrap-vcpkg.bat
      shell: cmd

    - name: Build MEGA SDK
      run: |
        cd third_party/sdk
        if (!(Test-Path "build_sdk")) { mkdir build_sdk }
        cd build_sdk
        cmake .. -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          -DVCPKG_OVERLAY_PORTS="${{ github.workspace }}/third_party/sdk/cmake/vcpkg_overlay_ports" `
          -DVCPKG_OVERLAY_TRIPLETS="${{ github.workspace }}/third_party/sdk/cmake/vcpkg_overlay_triplets" `
          -DVCPKG_MANIFEST_DIR="${{ github.workspace }}/third_party/sdk" `
          -DVCPKG_MANIFEST_INSTALL=ON `
          -DVCPKG_MANIFEST_FEATURES="use-openssl;use-freeimage;use-ffmpeg;use-libuv" `
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
          -DENABLE_SYNC=ON `
          -DENABLE_CHAT=OFF `
          -DENABLE_LOG_PERFORMANCE=OFF `
          -DENABLE_SDKLIB_EXAMPLES=OFF `
          -DENABLE_SDKLIB_TESTS=OFF `
          -DUSE_OPENSSL=ON `
          -DUSE_CURL=ON `
          -DUSE_SODIUM=ON `
          -DUSE_CRYPTOPP=ON `
          -DUSE_SQLITE=ON `
          -DUSE_FREEIMAGE=ON `
          -DUSE_FFMPEG=ON `
          -DUSE_MEDIAINFO=OFF `
          -DUSE_LIBUV=ON `
          -DUSE_PDFIUM=OFF
        cmake --build . --config ${{ env.BUILD_TYPE }} --parallel
      shell: pwsh
      timeout-minutes: 90

    - name: Configure Qt GUI
      run: |
        cd qt-gui
        cmake -B build-win64 -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }}" `
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
      shell: pwsh

    - name: Build Qt GUI
      run: |
        cd qt-gui
        cmake --build build-win64 --config ${{ env.BUILD_TYPE }} --parallel
      shell: pwsh

    - name: Create Portable Distribution
      run: |
        cd qt-gui

        # Create deployment directory
        $deployDir = "MegaCustomGUI-Portable"
        if (Test-Path $deployDir) { Remove-Item -Recurse -Force $deployDir }
        New-Item -ItemType Directory -Path $deployDir

        # Copy executable
        Copy-Item "build-win64/${{ env.BUILD_TYPE }}/MegaCustomGUI.exe" $deployDir/

        # Run windeployqt
        & "${{ env.Qt6_DIR }}/bin/windeployqt.exe" `
          --release `
          --no-translations `
          --no-system-d3d-compiler `
          --no-opengl-sw `
          "$deployDir/MegaCustomGUI.exe"

        # Copy vcpkg DLLs - check manifest mode location first, then classic
        $manifestBin = "${{ github.workspace }}/third_party/sdk/build_sdk/vcpkg_installed/x64-windows/bin"
        $manifestTools = "${{ github.workspace }}/third_party/sdk/build_sdk/vcpkg_installed/x64-windows/tools/ffmpeg"
        $vcpkgBin = "${{ github.workspace }}/vcpkg/installed/x64-windows/bin"
        $vcpkgTools = "${{ github.workspace }}/vcpkg/installed/x64-windows/tools/ffmpeg"

        # Copy all DLLs from vcpkg (manifest mode location preferred)
        if (Test-Path $manifestBin) {
          Get-ChildItem "$manifestBin/*.dll" | Copy-Item -Destination $deployDir/
          Write-Host "Copied vcpkg DLLs from manifest location"
          $toolsPath = $manifestTools
        } elseif (Test-Path $vcpkgBin) {
          Get-ChildItem "$vcpkgBin/*.dll" | Copy-Item -Destination $deployDir/
          Write-Host "Copied vcpkg DLLs from classic location"
          $toolsPath = $vcpkgTools
        }

        # Copy ffmpeg executables
        if (Test-Path $toolsPath) {
          Copy-Item "$toolsPath/ffmpeg.exe" $deployDir/ -ErrorAction SilentlyContinue
          Copy-Item "$toolsPath/ffprobe.exe" $deployDir/ -ErrorAction SilentlyContinue
          Write-Host "Copied ffmpeg tools"
        }

        # Create resources directory
        New-Item -ItemType Directory -Path "$deployDir/resources/styles" -Force
        New-Item -ItemType Directory -Path "$deployDir/resources/icons" -Force
        Copy-Item "resources/styles/*.qss" "$deployDir/resources/styles/" -ErrorAction SilentlyContinue
        Copy-Item "resources/icons/*.ico" "$deployDir/resources/icons/" -ErrorAction SilentlyContinue

        # Create portable marker
        $markerContent = "MegaCustomGUI Portable Mode`n`nThis file enables portable mode.`nSettings will be stored in this folder instead of AppData.`nDelete this file to use standard Windows settings location."
        Set-Content -Path "$deployDir/portable.marker" -Value $markerContent -Encoding UTF8

        # Create README
        $readmeContent = "MegaCustomGUI Portable`n======================`n`nThis is a portable version of MegaCustomGUI.`n`nTo run: Double-click MegaCustomGUI.exe`n`nPortable mode is enabled - all settings are stored in this folder.`nTo use standard Windows settings (AppData), delete the portable.marker file.`n`nSystem Requirements:`n- Windows 10 or later (64-bit)`n- No installation required"
        Set-Content -Path "$deployDir/README.txt" -Value $readmeContent -Encoding UTF8

        Write-Host "Portable distribution created in $deployDir"
        Get-ChildItem $deployDir
      shell: pwsh

    - name: Upload Portable Artifact
      uses: actions/upload-artifact@v4
      with:
        name: MegaCustomGUI-Portable-Win64
        path: qt-gui/MegaCustomGUI-Portable/
        retention-days: 30

    - name: Create Release ZIP
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        cd qt-gui
        Compress-Archive -Path "MegaCustomGUI-Portable" -DestinationPath "MegaCustomGUI-Portable-Win64.zip"
      shell: pwsh

    - name: Upload Release Asset
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: qt-gui/MegaCustomGUI-Portable-Win64.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
